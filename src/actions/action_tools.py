"""Определение доступных действий (tools) для AI-агента"""
from typing import List, Dict, Any


def get_action_tools() -> List[Dict[str, Any]]:
    """
    Получение списка доступных действий как OpenAI function definitions
    
    Returns:
        Список определений функций для OpenAI
    """
    return [
        {
            "type": "function",
            "function": {
                "name": "click_element",
                "description": "Клик по элементу на странице. ПРИНЦИП РАБОТЫ С СЕЛЕКТОРАМИ: Если у тебя есть селектор из предыдущего query_dom - используй его (selector=\"...\"). Это эффективнее поиска по описанию. Если селектора нет - используй описание элемента (description=\"...\"). АНАЛИЗ СТРАНИЦЫ: Подумай о структуре страницы - карточки, списки, таблицы, формы. Приоритет: модальные окна > формы > элементы с id > основной контент. ПРОВЕРКА РЕЗУЛЬТАТА: После клика подумай - изменилась ли страница как ожидалось? Если действие должно было привести к изменению, но page_changed=false - это сигнал что-то пошло не так. Не повторяй то же действие - подумай почему не сработало и попробуй другой подход.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "description": {
                            "type": "string",
                            "description": "Текстовое описание элемента для клика (например, 'кнопка Войти', 'ссылка на вакансии'). Используй если селектор неизвестен. Если есть селектор - лучше использовать его."
                        },
                        "selector": {
                            "type": "string",
                            "description": "CSS селектор элемента. ПРИНЦИП: Если у тебя есть селектор из предыдущего query_dom - используй его здесь. Это точнее и эффективнее поиска по описанию. Примеры: selector=\"div.MessageListItem__content--y26Sh\", selector=\"#delete\", selector=\".class-name\". Если селектор указан, description можно не указывать."
                        }
                    },
                    "required": []
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "type_text",
                "description": "Ввод текста в поле ввода. Используй описание поля (например, 'поле email', 'поле поиска') или селектор. Для многострочных полей (textarea) используй переносы строк (\\n). AJAX И ДИНАМИЧЕСКИЙ КОНТЕНТ: После ввода текста система автоматически ждет загрузки динамического контента. Проверь результат - появились ли новые элементы на странице, изменился ли контент или появилось модальное окно. Если ничего не изменилось, возможно нужно заполнить следующее поле или нажать кнопку отправки формы. В формах с AJAX контент может загружаться асинхронно - система ждет загрузки, но проверь контекст на новые элементы или сообщения.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "text": {
                            "type": "string",
                            "description": "Текст для ввода"
                        },
                        "element_description": {
                            "type": "string",
                            "description": "Описание поля ввода (например, 'поле email', 'поле поиска')"
                        },
                        "selector": {
                            "type": "string",
                            "description": "CSS селектор поля ввода (если известен)"
                        }
                    },
                    "required": ["text", "element_description"]
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "navigate",
                "description": "Переход по URL или поиск страницы на сайте. Используй url для прямого перехода или search_query для поиска через поисковую строку сайта. АНАЛИЗ СТРАНИЦЫ ПОСЛЕ ПЕРЕХОДА: После перехода проанализируй структуру новой страницы - карточки, списки, таблицы, формы. Проверь приоритет элементов: модальные окна > формы > элементы в основном контенте. ВАЖНО: После перехода проверь, изменилась ли страница (URL, заголовок, DOM). В SPA URL может измениться без полной перезагрузки - это нормально, DOM меняется асинхронно. Если URL изменился, но элементов нет - подожди 1-2 секунды для загрузки динамического контента. Если URL не изменился или остался тем же, что был ранее посещен, попробуй другой подход.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "url": {
                            "type": "string",
                            "description": "Полный URL для перехода (например, 'https://example.com/page')"
                        },
                        "search_query": {
                            "type": "string",
                            "description": "Поисковый запрос для поиска страницы на текущем сайте (если URL не указан)"
                        }
                    },
                    "required": []
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "search_on_page",
                "description": "Поиск через поисковую строку на текущей странице. Используй этот инструмент для поиска элементов (ресторанов, товаров, ссылок, вакансий) через поисковую строку сайта. Это более эффективно, чем поиск по элементам на странице. AJAX И ДИНАМИЧЕСКИЙ КОНТЕНТ: После поиска результаты могут загружаться динамически (AJAX). Система автоматически ждет загрузки результатов, но ты должен проверить контекст страницы - появились ли результаты поиска, новые элементы или карточки. Если результатов нет - подожди еще немного или попробуй другой поисковый запрос.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "query": {
                            "type": "string",
                            "description": "Поисковый запрос для ввода в поисковую строку сайта"
                        }
                    },
                    "required": ["query"]
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "scroll",
                "description": "Прокрутка страницы для поиска элементов или прокрутка до конкретного элемента. Используй scroll когда элемент не виден на экране или нужно загрузить больше контента (lazy loading). LAZY LOADING: После прокрутки система автоматически ждет загрузки динамического контента, но ты ОБЯЗАТЕЛЬНО должен проверить контекст страницы - появились ли новые элементы или нужная информация. Если достигнут конец страницы (is_at_bottom = true) - не прокручивай дальше, попробуй другой подход. Если прокрутка не изменила позицию (scrolled = false) - возможно, достигнут конец страницы. Если элемент не найден после прокрутки - прокрути дальше или используй другой подход.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "direction": {
                            "type": "string",
                            "enum": ["down", "up", "left", "right"],
                            "description": "Направление прокрутки. Используй 'down' для поиска элементов ниже на странице, 'up' для возврата к началу страницы."
                        },
                        "amount": {
                            "type": "integer",
                            "description": "Количество пикселей для прокрутки (по умолчанию 500). Больше значение = больше прокрутка.",
                            "default": 500
                        },
                        "to_element": {
                            "type": "string",
                            "description": "Описание элемента для прокрутки до него (опционально). Если указано, страница прокрутится до этого элемента. Используй когда знаешь, какой элемент нужно найти, но он не виден на экране."
                        }
                    },
                    "required": ["direction"]
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "reload_page",
                "description": "Перезагрузка текущей страницы. Используй этот инструмент только если на странице обнаружена критическая ошибка или страница не загрузилась корректно. Обычно лучше попробовать другой подход (scroll, другой элемент, альтернативная навигация) вместо перезагрузки. После перезагрузки система автоматически ждет загрузки контента.",
                "parameters": {
                    "type": "object",
                    "properties": {},
                    "required": []
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "wait_for_element",
                "description": "Ожидание появления элемента на странице. Используй когда элемент должен появиться динамически (AJAX, lazy loading, SPA навигация). Система автоматически ждет загрузки контента после действий, но если элемент должен появиться с задержкой - используй этот инструмент.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "description": {
                            "type": "string",
                            "description": "Описание ожидаемого элемента"
                        },
                        "selector": {
                            "type": "string",
                            "description": "CSS селектор элемента (если известен)"
                        },
                        "timeout": {
                            "type": "integer",
                            "description": "Таймаут ожидания в миллисекундах (по умолчанию 10000)",
                            "default": 10000
                        }
                    },
                    "required": ["description"]
                }
            }
        },
        # ЗАКОММЕНТИРОВАНО: Используй query_dom для получения информации о странице вместо extract_text
        # extract_text был заменен на query_dom как основной способ получения информации о странице
        # DOM Sub-agent дает детальные ответы с описанием элементов, их визуального состояния и селекторами
        # {
        #     "type": "function",
        #     "function": {
        #         "name": "extract_text",
        #         "description": "Извлечение текста из элемента или области страницы. АНАЛИЗ СТРАНИЦЫ: Проанализируй структуру страницы - карточки, списки, таблицы, статьи. Используй visible_text_preview для общего понимания содержимого. Используй описание элемента (например, 'резюме', 'профиль', 'описание вакансии', 'карточка товара'). ВАЖНО: Проверь extracted_info в контексте - если информация уже была извлечена, НЕ извлекай её повторно! Если элемент не найден - попробуй прокрутить страницу (scroll) для загрузки динамического контента или используй другое описание. Если extract_text завершился ошибкой - НЕ ПОВТОРЯЙ его с тем же описанием - попробуй scroll, затем другой подход.",
        #         "parameters": {
        #             "type": "object",
        #             "properties": {
        #                 "description": {
        #                     "type": "string",
        #                     "description": "Описание элемента или области для извлечения текста"
        #                 },
        #                 "selector": {
        #                     "type": "string",
        #                     "description": "CSS селектор элемента (если известен)"
        #                 }
        #             },
        #             "required": ["description"]
        #         }
        #     }
        # },
        {
            "type": "function",
            "function": {
                "name": "query_dom",
                "description": "КРИТИЧЕСКИ ВАЖНО: Это ЕДИНСТВЕННЫЙ способ получить информацию о структуре страницы, элементах и их селекторах. ВСЕГДА используй query_dom когда нужна информация о странице. ПРИНЦИП: query_dom получает информацию о структуре страницы через DOM Sub-agent, не изменяет страницу. DOM Sub-agent анализирует структуру страницы и дает детальные ответы с описанием элементов, их визуального состояния и селекторами. КОГДА ИСПОЛЬЗОВАТЬ: Перед кликом по элементу (если нет селектора), перед вводом текста (если нужно найти поле), когда нужно понять структуру страницы, когда нужно найти элементы, после действий для проверки результата, когда нужно понять визуальное состояние элементов (что отображается, какие иконки, счетчики). ФОРМИРОВАНИЕ ВОПРОСОВ: Не используй заготовленные шаблоны! Каждая ситуация уникальна. Подумай самостоятельно: что тебе нужно узнать для выполнения задачи? Сформулируй вопрос так, чтобы получить нужную информацию. Процесс мышления: 1) Что мне нужно сделать? 2) Что мне нужно узнать для этого? 3) Какой вопрос поможет получить эту информацию? Фокусируйся на конкретном элементе или результате, а не на всей странице. Указывай контекст (где находится, после какого действия). ВСЕГДА проси селектор в ответе. Проси описание визуального состояния если это релевантно. Вопрос должен быть конкретным и релевантным к твоей задаче.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "query": {
                            "type": "string",
                            "description": "Конкретный вопрос о конкретном элементе на странице, его селекторе или состоянии. Принцип: не используй заготовленные шаблоны! Каждая ситуация уникальна. Подумай самостоятельно: что тебе нужно узнать для выполнения задачи? Сформулируй вопрос так, чтобы получить нужную информацию. Процесс мышления: 1) Что мне нужно сделать? 2) Что мне нужно узнать для этого? 3) Какой вопрос поможет получить эту информацию? Фокусируйся на конкретном элементе или результате действия, а не на всей странице. Указывай контекст (где находится элемент, после какого действия). ВСЕГДА проси селектор в ответе. Проси описание визуального состояния если это релевантно (что отображается, какие иконки, счетчики). Вопрос должен быть конкретным и релевантным к твоей задаче."
                        }
                    },
                    "required": ["query"]
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "take_screenshot",
                "description": "ОБЯЗАТЕЛЬНЫЙ инструмент для визуального анализа страницы! Создание скриншота текущей страницы. Скриншоты автоматически сохраняются в директорию screenshots/ с timestamp. ПАРАМЕТР full_page: По умолчанию full_page=false (скриншот только видимой области) - быстрее и меньше размер. Используй full_page=true только когда нужна полная страница (например, для анализа всей структуры после navigate). КРИТИЧЕСКИ ВАЖНО: Каждый скриншот АВТОМАТИЧЕСКИ анализируется через Vision API (если модель поддерживает vision)! Результат анализа доступен в vision_analysis результата действия. Скриншоты используются для ВАЛИДАЦИИ РЕЗУЛЬТАТОВ действий! После каждого критического действия ОБЯЗАТЕЛЬНО делай скриншот. ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА ИСПОЛЬЗОВАНИЯ (БЕЗ ИСКЛЮЧЕНИЙ!): 1) ПОСЛЕ navigate() - ОБЯЗАТЕЛЬНО делай take_screenshot(full_page=true) → используй vision_analysis для понимания структуры страницы → затем планируй следующее действие. ПРАВИЛО: navigate() → take_screenshot(full_page=true) → используй vision_analysis → действие. 2) ПОСЛЕ click_element() для валидации результата - ОБЯЗАТЕЛЬНО делай take_screenshot(full_page=false) → используй vision_analysis для проверки результата. ПРАВИЛО: click_element() → take_screenshot(full_page=false) → используй vision_analysis → проверка результата. 3) ПОСЛЕ type_text() в важные поля (поиск, формы) - ОБЯЗАТЕЛЬНО делай take_screenshot(full_page=false) → используй vision_analysis. ПРАВИЛО: type_text() → take_screenshot(full_page=false) → используй vision_analysis. 4) КОГДА page_changed = false после действия - ОБЯЗАТЕЛЬНО сделай take_screenshot(full_page=false) → используй vision_analysis для диагностики проблемы. ПРАВИЛО: page_changed = false → take_screenshot(full_page=false) → используй vision_analysis → другой подход. Vision анализ автоматически найдет элементы на скриншоте и опишет структуру страницы - используй эту информацию для действий!",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "description": {
                            "type": "string",
                            "description": "Описание скриншота (опционально, используется в имени файла)"
                        },
                        "action": {
                            "type": "string",
                            "description": "Тип действия, при котором сделан скриншот (опционально, используется в имени файла)"
                        },
                        "full_page": {
                            "type": "boolean",
                            "description": "Делать скриншот всей страницы или только видимой области (опционально, по умолчанию false - только видимая область). Используй true для полной страницы после navigate, false для быстрых проверок после действий.",
                            "default": False
                        },
                    },
                    "required": []
                }
            }
        },
        {
            "type": "function",
            "function": {
                "name": "task_complete",
                "description": "Сообщить, что задача выполнена. ВАЛИДАЦИЯ: Перед использованием убедись, что все шаги задачи выполнены, цель достигнута, и все действия привели к ожидаемым результатам. Проверь, что нет невыполненных шагов и что валидация результатов действий пройдена. Используй это действие только когда задача действительно выполнена.",
                "parameters": {
                    "type": "object",
                    "properties": {
                        "summary": {
                            "type": "string",
                            "description": "Краткое описание выполненной задачи"
                        }
                    },
                    "required": ["summary"]
                }
            }
        },
    ]

